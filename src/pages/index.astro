---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import WeekSelector from '../components/WeekSelector.astro';
import TagFilter from '../components/TagFilter.astro';
import { getArticlesByWeek, getWeekStartDates, getAllTags, getTopTags, getArticlesByTag } from '../lib/db';
import { getWeekStartDate, isValidMonday } from '../lib/utils';

// Get current week start date
const currentWeek = getWeekStartDate();

// Get query params
const url = Astro.url;
const tagParam = url.searchParams.get('tag');

// Get database from runtime
const db = Astro.locals.runtime?.env?.DB;

if (!db) {
  return new Response('Database not available', { status: 500 });
}

// Get all weeks and tags for navigation
const [weeks, allTags, topTags] = await Promise.all([
  getWeekStartDates(db),
  getAllTags(db),
  getTopTags(db, 20),
]);

// Get articles
let articles;
if (tagParam) {
  articles = await getArticlesByTag(db, tagParam, currentWeek);
} else {
  articles = await getArticlesByWeek(db, currentWeek);
}

const pageTitle = tagParam 
  ? `Archive - ${tagParam} (${currentWeek})`
  : `Archive - Week of ${currentWeek}`;
---

<Layout title={pageTitle}>
  <div class="archive-page">
    <div class="archive-layout">
      <aside class="sidebar">
        <WeekSelector currentWeek={currentWeek} weeks={weeks} />
        
        {allTags.length > 0 && (
          <TagFilter allTags={allTags} topTags={topTags} currentTag={tagParam || undefined} />
        )}
      </aside>

      <main class="content">
        {articles.length > 0 ? (
          <div class="articles-list">
            {articles.map((article) => (
              <ArticleCard article={article} />
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <p>No articles found for this week{tagParam ? ` with tag "${tagParam}"` : ''}.</p>
          </div>
        )}
      </main>
    </div>
  </div>
</Layout>

<style>
  .archive-page {
    max-width: 100%;
  }

  .archive-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 2rem;
    align-items: start;
  }

  .sidebar {
    position: sticky;
    top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .content {
    min-width: 0;
  }

  .articles-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .empty-state {
    background: white;
    padding: 3rem;
    border-radius: 8px;
    text-align: center;
    color: #666;
  }

  @media (max-width: 968px) {
    .archive-layout {
      grid-template-columns: 1fr;
    }

    .sidebar {
      position: static;
    }
  }
</style>
